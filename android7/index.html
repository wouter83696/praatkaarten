<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Praatkaarten v3.7.1</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>
<script id="questions-json" type="application/json">
{
  "verkennen": [
    "Wat zien we op dit moment gebeuren in onze samenwerking?",
    "Wat valt ons op in onze manier van samenwerken?",
    "Herkennen we patronen in onze manier van samenwerken?",
    "Waar zijn we aan gewend geraakt?",
    "Wat krijgt nu minder aandacht?",
    "Blijven er dingen onbesproken?"
  ],
  "duiden": [
    "Wat proberen we als team goed te doen?",
    "Wat nemen we wel of niet als vanzelfsprekend aan?",
    "Wanneer helpt afstemming ons, en wanneer belemmert het ons?",
    "Wat maakt dat onze kwaliteiten wel of niet tot hun recht komen?",
    "Welke patronen blijven we terugzien in onze samenwerking?",
    "Welke factoren blijven onbenoemd, terwijl ze wel invloed hebben?"
  ],
  "verbinden": [
    "Waar worden we enthousiast van?",
    "Wanneer voel jij je echt onderdeel van het team?",
    "Mogen er verschillen bestaan in ons team?",
    "Hoe kunnen we elkaar uitdagen en andere kanten belichten?",
    "Wat helpt ons om onszelf te laten zien in de samenwerking?",
    "Wat helpt om eerlijk te zijn, zonder de verbinding te verliezen?"
  ],
  "verhelderen": [
    "Wat is voor ons op dit moment nog onduidelijk in de samenwerking?",
    "Welke aannames doen we (bewust of onbewust) over elkaar of de situatie?",
    "Welke informatie missen we om goed te kunnen samenwerken?",
    "Wat bedoelen we precies als we woorden gebruiken als ‘afstemming’, ‘ruimte’ of ‘tempo’?",
    "Welke verwachtingen spreken we niet uit, maar sturen wel ons gedrag?",
    "Wat zou helpen om de afspraak of werkwijze helder en concreet te maken?"
  ],
  "vertragen": [
    "Wanneer nemen we in onze samenwerking eigenlijk de tijd?",
    "Wat verandert er in onze samenwerking wanneer we een reactie uitstellen?",
    "Wat gebeurt er in onze samenwerking wanneer we het tempo bewust verlagen?",
    "Welke patronen worden zichtbaar wanneer de druk toeneemt?",
    "Welke rol nemen we automatisch aan in momenten van spanning?",
    "Wanneer merken we dat vertragen helpend zou zijn?"
  ],
  "bewegen": [
    "Wat doen we met ideeën die ontstaan?",
    "Wanneer komt er beweging in het team?",
    "Wat helpt ons om van praten naar doen te gaan?",
    "Welke ideeën blijven liggen, en waarom?",
    "Wat houdt ons tegen om in actie te komen?",
    "Wat laten we liggen, terwijl het eigenlijk aandacht vraagt?"
  ]
}
</script>


<header class="topBar" aria-label="Bovenbalk">
  <button id="themePill" class="themePill" type="button" aria-haspopup="dialog" aria-expanded="false"><img id="setCoverIcon" class="setCoverIcon" src="sets/samenwerken/cards/voorkant.svg?v=371b" alt="" aria-hidden="true">
<span id="themePillText" class="srOnly">samenwerken</span></button>

  <div class="topTools" aria-label="Acties">
    <button id="shuffleBtn" class="toolBtn gmFab" type="button" aria-label="Shuffle"><svg class="gmIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
  <path d="M16 3h5v5"></path>
  <path d="M4 7h6c1.8 0 3.2.7 4.3 2l.7.8"></path>
  <path d="M21 3l-6 6"></path>
  <path d="M16 21h5v-5"></path>
  <path d="M4 17h6c1.8 0 3.2-.7 4.3-2l.7-.8"></path>
  <path d="M21 21l-6-6"></path>
</svg></button>
    <button id="uitlegBtn" class="toolBtn gmFab" type="button" aria-label="Uitleg"><svg class="gmIcon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
  <circle cx="12" cy="12" r="9"></circle>
  <path d="M12 10.5v6"></path>
  <path d="M12 7.5h.01"></path>
</svg></button>
  </div>
</header>

<div id="themeMenuOverlay" class="menuOverlay" hidden></div>
<section id="themeMenu" class="themeMenu" role="dialog" aria-label="Menu" hidden>
  <div class="menuCard">
    <div class="menuHeader">Thema's</div>
    <div id="menuList" class="menuList">
      <!-- Wordt dynamisch gevuld -->
    </div>
<div class="menuFooter">
      <button id="naarOverzicht" class="menuLink" type="button">Naar overzicht →</button>
    </div>
  </div>
</section>

<main class="page">
  <div id="grid" class="grid" aria-label="Kaarten"></div>
</main>

<script>
(function(){
  'use strict';

  // --- Android-safe polyfills (oude WebViews / striktere browsers) ---
  // Element.matches
  if(!Element.prototype.matches){
    Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
  }
  // Element.closest
  if(!Element.prototype.closest){
    Element.prototype.closest = function(sel){
      var el = this;
      while(el && el.nodeType === 1){
        if(el.matches && el.matches(sel)) return el;
        el = el.parentElement || el.parentNode;
      }
      return null;
    };
  }

  // ES5-only, iOS-safe query parsing (geen URL/URLSearchParams)
  function getQueryParam(name){
    var s = window.location.search || '';
    if(s.charAt(0)==='?') s=s.substring(1);
    var parts = s.split('&');
    for(var i=0;i<parts.length;i++){ 
      var kv = parts[i].split('=');
      if(decodeURIComponent(kv[0]||'')===name) return decodeURIComponent(kv[1]||'');
    }
    return '';
  }

  function getActiveSet(){
    var s = (getQueryParam('set') || getQueryParam('s') || '').trim();
    return s ? s : 'samenwerken';
  }

  function setBase(){
    // relatieve paden
    return 'sets/' + encodeURIComponent(getActiveSet()) + '/';
  }

  function withV(url){
    // cache-busting (Android + sommige hosts blijven hard cachen)
    var v = '371b';
    if(url.indexOf('?') !== -1) return url + '&v=' + v;
    return url + '?v=' + v;
  }


  function setThemePillText(){
    var pillText = document.getElementById('themePillText');
    if(pillText) pillText.textContent = prettyName(getActiveSet());
  }

  function prettyName(setId){
    var s = String(setId||'').toLowerCase();
    if(s==='check-in' || s==='checkin') return 'Check-in';
    if(s==='samenwerken') return 'Samenwerken';
    if(s==='verbinden') return 'Verbinden';
    if(s==='verkennen') return 'Verkennen';
    if(s==='verhelderen') return 'Verhelderen';
    if(s==='vertragen') return 'Vertragen';
    if(s==='bewegen') return 'Bewegen';
    if(s==='teamstart') return 'Teamstart';
    if(s==='reflectie') return 'Reflectie';
    if(s==='spanning') return 'Spanning';
    if(s==='feedback') return 'Feedback';
    if(s==='energie') return 'Energie';
    // fallback: Capitalize
    return s ? (s.charAt(0).toUpperCase()+s.slice(1)) : 'Samenwerken';
  }

  function openMenu(){
    var menu = document.getElementById('themeMenu');
    var overlay = document.getElementById('themeMenuOverlay');
    var pill = document.getElementById('themePill');
    if(menu){ menu.hidden = false; }
    if(overlay){ overlay.hidden = false; }
    if(pill){ pill.setAttribute('aria-expanded','true'); }
  }

  function closeMenu(){
    var menu = document.getElementById('themeMenu');
    var overlay = document.getElementById('themeMenuOverlay');
    var pill = document.getElementById('themePill');
    if(menu){ menu.hidden = true; }
    if(overlay){ overlay.hidden = true; }
    if(pill){ pill.setAttribute('aria-expanded','false'); }
  }


  var THEMES = []; // dynamisch uit meta.json
  var CARD_BASE = 'sets/samenwerken/cards/';
  var CURRENT_SET = 'samenwerken';
  var CURRENT_META = null;
  var grid = document.getElementById('grid');
  if(!grid) return;

  function parseInlineQuestions(){
    try{
      var el = document.getElementById('questions-json');
      if(el && el.textContent && el.textContent.replace(/\s+/g,'').length) return JSON.parse(el.textContent);
    }catch(e){}
    return null;
  }

  function loadJson(url){
    return new Promise(function(resolve, reject){
      try{
        var xhr = new XMLHttpRequest();
        xhr.open('GET', withV(url), true);
        xhr.onreadystatechange = function(){
          if(xhr.readyState !== 4) return;
          if(xhr.status !== 200){
            reject(new Error('HTTP ' + xhr.status + ' ' + url));
            return;
          }
          var txt = (xhr.responseText || '').trim();
          // Als we HTML terugkrijgen (host/redirect/404), faalt JSON.parse op Android
          if(txt.charAt(0) === '<'){
            reject(new Error('Geen JSON ontvangen (' + url + '). Eerste tekens: ' + txt.slice(0,20)));
            return;
          }
          try{
            resolve(JSON.parse(txt));
          }catch(e){
            reject(e);
          }
        };
        xhr.send(null);
      }catch(e){
        reject(e);
      }
    });
  }

  function resolveActiveSet(){
    var fromUrl = (getQueryParam('set') || getQueryParam('s') || '').trim();
    return loadJson('sets/index.json').then(function(idx){
      var sets = Array.isArray(idx.sets) ? idx.sets : [];
      var available = sets.map(function(x){ return x.id; });
      var def = (idx.default || '').trim();

      if(fromUrl && available.indexOf(fromUrl)!==-1) return fromUrl;
      if(def && available.indexOf(def)!==-1) return def;
      if(available.length) return available[0];
      return fromUrl || 'samenwerken';
    }).catch(function(){
      return fromUrl || 'samenwerken';
    });
  }

  function applySetMeta(setId, meta){
    CURRENT_SET = setId;
    CURRENT_META = meta || null;
    CARD_BASE = 'sets/' + encodeURIComponent(setId) + '/cards/';

    // cover linksboven
    var icon = document.getElementById('setCoverIcon');
    if(icon){
      var cover = (meta && meta.cover) ? meta.cover : 'voorkant.svg';
      icon.setAttribute('src', withV(CARD_BASE + cover));
    }

    // aria label (context)
    var pill = document.getElementById('themePill');
    if(pill){
      pill.setAttribute('aria-label', (meta && meta.name) ? meta.name : setId);
    }

    // THEMES uit meta
    THEMES = [];
    if(meta && Array.isArray(meta.themes)){
      for(var i=0;i<meta.themes.length;i++){
        var k = String((meta.themes[i]||{}).key||'').trim();
        if(k) THEMES.push(k);
      }
    }

    // menu bouwen
    var menuList = document.getElementById('menuList');
    if(menuList){
      menuList.innerHTML = '';
      if(meta && Array.isArray(meta.themes)){
        for(var j=0;j<meta.themes.length;j++){
          var th = meta.themes[j] || {};
          var key = String(th.key||'').trim();
          if(!key) continue;

          var btn = document.createElement('button');
          btn.className = 'menuItem themeItem';
          btn.type = 'button';
          btn.setAttribute('data-set', key);

          var lab = document.createElement('span');
          lab.className = 'miLabel';
          lab.textContent = (th.label || key);

                    var thumb = document.createElement('span');
          thumb.className = 'miThumbRight';
          thumb.setAttribute('aria-hidden','true');

          // Thumbnail: zelfde styling als index-kaarten (maar klein)
          var mini = document.createElement('div');
          mini.className = 'menuThumbCard';

          var miniImg = document.createElement('img');
          miniImg.className = 'bg';
          var cardFile = th.card || (key + '.svg');
          miniImg.src = withV('sets/' + encodeURIComponent(setId) + '/cards/' + cardFile);
          miniImg.alt = '';

          mini.appendChild(miniImg);
          thumb.appendChild(mini);
btn.appendChild(lab);
          btn.appendChild(thumb);
          menuList.appendChild(btn);
        }
      }
    }
  }

  function loadMeta(setId){
    return loadJson('sets/' + encodeURIComponent(setId) + '/meta.json');
  }

  function loadQuestions(setId){
    return loadJson('sets/' + encodeURIComponent(setId) + '/questions.json').catch(function(){
      return parseInlineQuestions();
    });
  }



  function cardUrl(themeKey){
    // kaartbestand uit meta (t.card), anders themeKey+'.svg'
    var file = themeKey + '.svg';
    if(CURRENT_META && Array.isArray(CURRENT_META.themes)){
      for(var i=0;i<CURRENT_META.themes.length;i++){
        var t = CURRENT_META.themes[i] || {};
        if(String(t.key||'').trim()===themeKey){ file = (t.card || file); break; }
      }
    }
    return CARD_BASE + file;
  }

  function buildData(qObj){
    var out=[];
    for(var t=0;t<THEMES.length;t++){ 
      var theme=THEMES[t];
      var arr=(qObj && qObj[theme]) ? qObj[theme] : [];
      for(var i=0;i<arr.length;i++){ 
        out.push({ theme:theme, q:String(arr[i]||''), bg:cardUrl(theme) });
      }
    }
    return out;
  }

  function showError(msg){
    grid.innerHTML = '<div style="padding:24px;font-family:system-ui;color:#444;">'+msg+'</div>';
  }

  resolveActiveSet().then(function(setId){
    return loadMeta(setId).then(function(meta){
      applySetMeta(setId, meta);
      return loadQuestions(setId);
    });
  }).then(function(qObj){
    if(!qObj){ showError('Fout bij laden.'); return; }
    var items = buildData(qObj);
    if(!items.length){ showError('Geen kaarten gevonden.'); return; }


  grid.innerHTML='';
  var frag=document.createDocumentFragment();
  for(var k=0;k<items.length;k++){ 
    var it=items[k];
    var btn=document.createElement('button');
    btn.className='card';
    btn.setAttribute('data-theme', it.theme);
    btn.type='button';

    var inner=document.createElement('div');
    inner.className='cardInner';

    var img=document.createElement('img');
    img.className='bg';
    img.src=withV(it.bg);
    img.alt='';

    var q=document.createElement('div');
    q.className='q';
    var span=document.createElement('span');
    span.className='qText';
    span.textContent=it.q;
    q.appendChild(span);

    inner.appendChild(img);
    inner.appendChild(q);
    btn.appendChild(inner);
    frag.appendChild(btn);
  }
  grid.appendChild(frag);
  }).catch(function(e){
    showError('Fout bij laden.');
    console.error(e);
  });

  setThemePillText();

  // Menu wiring
  var pillBtn = document.getElementById('themePill');
  if(pillBtn){
    pillBtn.onclick = function(){
      var expanded = pillBtn.getAttribute('aria-expanded') === 'true';
      if(expanded) closeMenu(); else openMenu();
    };
  }
  var overlay = document.getElementById('themeMenuOverlay');
  if(overlay){ overlay.onclick = closeMenu; }

  
  // Menu click: delegated (werkt ook voor dynamisch toegevoegde items)
  function scrollToTheme(themeKey){
    var target = grid.querySelector('.card[data-theme="' + themeKey + '"]');
    // iOS/Safari: close menu eerst, dan scroll na layout commit
    closeMenu();
    window.setTimeout(function(){
      if(target && target.scrollIntoView){
        // Sommige Android WebViews ondersteunen de options-object variant niet
        try{
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }catch(err){
          target.scrollIntoView(true);
        }
      }
    }, 80);
  }

  var menuList = document.getElementById('menuList');
  if(menuList){
    menuList.addEventListener('click', function(e){
      var btn = e.target && (e.target.closest ? e.target.closest('button[data-set]') : null);
      if(!btn) return;
      var themeKey = (btn.getAttribute('data-set') || '').trim();
      if(!themeKey) return;

      // pill tekst = label uit menu
      var labelEl = btn.querySelector('.miLabel');
      var labelTxt = labelEl ? (labelEl.textContent || '').trim() : capitalizeTheme(themeKey);
      setThemePillText(labelTxt);

      scrollToTheme(themeKey);
    });
  }

// Zorg: menu moet altijd sluiten na een themakeuze (ook als andere handlers later overriden)
  var menuListEl = document.querySelector('#themeMenu .menuList');
  if(menuListEl){
    menuListEl.addEventListener('click', function(e){
      var btn = e.target && (e.target.closest ? e.target.closest('button[data-set]') : null);
      if(btn){
        closeMenu();
      }
    }, true);
  }

var naarOverzicht = document.getElementById('naarOverzicht');
  if(naarOverzicht){
    naarOverzicht.onclick = function(){
      closeMenu();
      // placeholder: naar index zonder set param
      window.location.href = 'index.html';
    };
  }

  // Esc sluit menu (desktop)
  document.addEventListener('keydown', function(ev){
    ev = ev || window.event;
    if(ev.key === 'Escape') closeMenu();
  });


  // Buttons
  var shuffleBtn = document.getElementById('shuffleBtn');
  if(shuffleBtn){
    shuffleBtn.onclick = function(){
      var cards = Array.prototype.slice.call(grid.querySelectorAll('.card'));
      for(var i=cards.length-1;i>0;i--){
        var j=Math.floor(Math.random()*(i+1));
        var tmp=cards[i]; cards[i]=cards[j]; cards[j]=tmp;
      }
      grid.innerHTML='';
      for(var k2=0;k2<cards.length;k2++) grid.appendChild(cards[k2]);
    };
  }

  var uitlegBtn = document.getElementById('uitlegBtn');
  if(uitlegBtn){
    uitlegBtn.onclick = function(){
      window.location.href = 'uitleg/uitleg.html?set=' + encodeURIComponent(getActiveSet());
    };
  }

})();
</script>
</body>
</html>
